<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FoodieGo | Dashboard</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<style>
body {
  font-family: 'Poppins', sans-serif;
  background-color: #f7f8fa;
}
.navbar {
  background: #ffffff;
  box-shadow: 0 2px 12px rgba(0,0,0,0.06);
  padding: 15px 0;
}
.navbar-brand {
  color: #28a745 !important;
  font-weight: 700;
  font-size: 1.4rem;
}
.cart-btn {
  background: #28a745;
  color: white;
  border-radius: 25px;
  padding: 6px 15px;
}
.cart-badge {
  background: #ff3d3d;
  font-size: 0.7rem;
}
.food-card {
  border: none;
  border-radius: 20px;
  box-shadow: 0 10px 25px rgba(0,0,0,0.08);
  transition: 0.3s;
  overflow: hidden;
}
.food-card:hover {
  transform: translateY(-6px);
}
.food-img {
  width: 100%;
  height: 180px;
  object-fit: cover;
}
.price {
  color: #28a745;
  font-weight: 600;
  font-size: 1.1rem;
}
.btn-add {
  background: #28a745;
  color: white;
  border-radius: 30px;
}
.btn-add:hover {
  background: #218838;
}
</style>
</head>

<body>

<!-- NAVBAR -->
<nav class="navbar navbar-expand-lg">
  <div class="container">
    <a class="navbar-brand">üç¥ FoodieGo</a>
    <div class="ms-auto d-flex align-items-center gap-3">
      <a href="cart.html" class="cart-btn position-relative text-decoration-none">
        üõí Cart
        <span id="cartCount" class="position-absolute top-0 start-100 translate-middle badge rounded-pill cart-badge">0</span>
      </a>
      <div class="dropdown">
        <a class="dropdown-toggle text-decoration-none" data-bs-toggle="dropdown">
          üë§ <span id="userName"></span>
        </a>
        <ul class="dropdown-menu dropdown-menu-end shadow">
          <li class="dropdown-item-text fw-bold" id="dropdownUserName"></li>
          <li><hr></li>
          <li><a class="dropdown-item" onclick="logout()">Logout</a></li>
        </ul>
      </div>
    </div>
  </div>
</nav>

<!-- SEARCH -->
<div class="container mt-4">
  <h4 class="fw-bold">üçî Popular Foods</h4>
  <p class="text-muted">Choose your favorite meal</p>
  <div class="row mb-3">
    <div class="col-md-6">
      <input id="searchFood" class="form-control" placeholder="üîç Search food...">
    </div>
    <div class="col-md-4">
      <select id="priceFilter" class="form-select">
        <option value="all">All Prices</option>
        <option value="low">Under 100</option>
        <option value="mid">100 - 200</option>
        <option value="high">Above 200</option>
      </select>
    </div>
  </div>
</div>

<!-- FOODS -->
<div class="container mt-3">
  <div class="row g-4" id="food-container"></div>
</div>

<!-- TOAST -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
  <div id="cartToast" class="toast text-bg-success border-0">
    <div class="d-flex">
      <div class="toast-body">
        ‚úÖ Item added to cart
      </div>
      <button class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>

<script>
/* ===== AUTH CHECK ===== */
const user = JSON.parse(localStorage.getItem("user"));
if (!user || user.role !== "customer") {
  location.href = "login.html";
}

document.getElementById("userName").textContent = user.name;
document.getElementById("dropdownUserName").textContent = user.name;
/* ====================== */

const cartCount = document.getElementById("cartCount");
const foodContainer = document.getElementById("food-container");

function getCart() {
  return JSON.parse(localStorage.getItem("cart")) || [];
}

function updateCartCount() {
  cartCount.textContent = getCart().reduce((s, i) => s + i.quantity, 0);
}

function showCartToast() {
  const toast = new bootstrap.Toast(document.getElementById("cartToast"), {
    delay: 1200
  });
  toast.show();
}

function addToCartQty(id, name, price, image) {
  try {
    let cart = getCart();
    const qty = parseInt(document.querySelector(`.qty-${id}`).value) || 1;

    let item = cart.find(i => i.id === id);
    if (item) item.quantity += qty;
    else cart.push({ id, name, price, image, quantity: qty });

    localStorage.setItem("cart", JSON.stringify(cart));
    updateCartCount();
    showCartToast();

  } catch {
    console.log("Silent cart error");
  }
}

function fixImagePath(img) {
  if (!img.startsWith("http")) {
    return "http://127.0.0.1:5000/static/images/" + img.replace("images/", "");
  }
  return img;
}

function loadFoods() {
  fetch("http://127.0.0.1:5000/foods")
    .then(res => res.json())
    .then(data => {
      foodContainer.innerHTML = "";
      const search = searchFood.value.toLowerCase();
      const filter = priceFilter.value;

      data.filter(f => {
        if (!f.name.toLowerCase().includes(search)) return false;
        if (filter === "low" && f.price >= 100) return false;
        if (filter === "mid" && (f.price < 100 || f.price > 200)) return false;
        if (filter === "high" && f.price <= 200) return false;
        return true;
      }).forEach(f => {
        const img = fixImagePath(f.image);
        foodContainer.innerHTML += `
        <div class="col-md-4">
          <div class="card food-card">
            <img src="${img}" class="food-img">
            <div class="p-3">
              <h6>${f.name}</h6>
              <p class="price">${f.price} baht</p>
              <div class="d-flex gap-2">
                <input type="number" min="1" value="1" class="form-control qty-${f.id}">
                <button class="btn btn-add flex-fill"
                  onclick="addToCartQty(${f.id}, '${f.name}', ${f.price}, '${img}')">
                  Add
                </button>
              </div>
            </div>
          </div>
        </div>`;
      });
    })
    .catch(() => console.log("Food load failed silently"));
}

function logout() {
  localStorage.clear();
  location.href = "login.html";
}

searchFood.addEventListener("input", loadFoods);
priceFilter.addEventListener("change", loadFoods);

loadFoods();
updateCartCount();
</script>

</body>
</html>
