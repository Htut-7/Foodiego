<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FoodieGo | Cart</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">

<!-- QR Code library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<style>
body{font-family:Poppins,sans-serif;background:#f7f8fa;}
.navbar{background:#fff;box-shadow:0 2px 12px rgba(0,0,0,.06);}
.navbar-brand{color:#28a745!important;font-weight:700;}
.cart-card,.summary-box{border:none;border-radius:18px;box-shadow:0 10px 25px rgba(0,0,0,.08);}
.cart-item{display:flex;justify-content:space-between;padding:.75rem 0;border-bottom:1px solid #eee;}
.price{color:#28a745;font-weight:600;}
.toast-msg{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#28a745;color:#fff;padding:10px 20px;border-radius:25px;box-shadow:0 6px 20px rgba(0,0,0,.2);z-index:9999;}
</style>
</head>
<body>

<nav class="navbar mb-4">
  <div class="container d-flex justify-content-between">
    <a class="navbar-brand">üç¥ FoodieGo</a>
    <a href="dashboard.html" class="btn btn-outline-success btn-sm">‚¨Ö Back</a>
  </div>
</nav>

<div class="container">
<h4 class="fw-bold mb-3">üõí Your Cart</h4>

<div class="row g-4">
<!-- LEFT -->
<div class="col-md-8">
<div class="card cart-card p-4">

<div id="cart-items"></div>

<div class="d-flex justify-content-between mt-3">
  <strong>Subtotal</strong>
  <span class="price" id="subTotal">0</span>
</div>

<hr>

<h6 class="fw-bold">üìç Delivery Address</h6>
<select id="addressSelect" class="form-select mb-2"></select>
<button class="btn btn-outline-success btn-sm w-100" data-bs-toggle="modal" data-bs-target="#addressModal">‚ûï Add New Address</button>

<hr>

<h6 class="fw-bold">üöö Delivery</h6>
<div class="form-check">
  <input class="form-check-input" type="radio" name="delivery" id="delStandard" checked>
  <label class="form-check-label">Standard (Free)</label>
</div>
<div class="form-check">
  <input class="form-check-input" type="radio" name="delivery" id="delExpress">
  <label class="form-check-label">Express (+30)</label>
</div>

<hr>

<h6 class="fw-bold">üí≥ Payment</h6>
<div class="form-check">
  <input class="form-check-input" type="radio" name="payment" id="paymentCOD" checked>
  <label class="form-check-label" for="paymentCOD">Cash on Delivery</label>
</div>
<div class="form-check">
  <input class="form-check-input" type="radio" name="payment" id="paymentQR">
  <label class="form-check-label" for="paymentQR">Pay with QR</label>
</div>

<!-- QR container -->
<div id="qrContainer" class="mt-3 text-center" style="display:none;">
  <h6>Scan QR to pay</h6>
  <div id="qrcode"></div>
</div>

</div>
</div>

<!-- RIGHT -->
<div class="col-md-4">
<div class="summary-box p-4">
<h6 class="fw-bold">üßæ Summary</h6>
<p>Subtotal: <span id="sumSubtotal">0</span></p>
<p>Delivery: <span id="deliveryFee">0</span></p>
<hr>
<h5>Total: <span class="price" id="grandTotal">0</span></h5>

<button class="btn btn-success w-100 mt-3" onclick="checkout()">Checkout</button>
</div>
</div>
</div>
</div>

<!-- ADDRESS MODAL -->
<div class="modal fade" id="addressModal">
<div class="modal-dialog modal-dialog-centered">
<div class="modal-content rounded-4">
<div class="modal-header">
<h5>Add Address</h5>
<button class="btn-close" data-bs-dismiss="modal"></button>
</div>
<div class="modal-body">
<input id="addrLine" class="form-control mb-2" placeholder="Address line">
<input id="addrCity" class="form-control mb-2" placeholder="City">
<input id="addrPostal" class="form-control mb-2" placeholder="Postal code">
<input id="addrPhone" class="form-control mb-2" placeholder="Phone">
</div>
<div class="modal-footer">
<button class="btn btn-success w-100" id="saveAddressBtn">Save</button>
</div>
</div>
</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
<script>
/* ===== AUTH ===== */
const user = JSON.parse(localStorage.getItem("user"));
if(!user || user.role!=="customer") location.href="login.html";

/* ===== ELEMENTS ===== */
const cartBox = document.getElementById("cart-items");
const subTotal = document.getElementById("subTotal");
const sumSubtotal = document.getElementById("sumSubtotal");
const deliveryFee = document.getElementById("deliveryFee");
const grandTotal = document.getElementById("grandTotal");
const addressSelect = document.getElementById("addressSelect");

const delStandard = document.getElementById("delStandard");
const delExpress = document.getElementById("delExpress");

const paymentCOD = document.getElementById("paymentCOD");
const paymentQR = document.getElementById("paymentQR");
const qrContainer = document.getElementById("qrContainer");
let qr;

delStandard.onchange = updateTotal;
delExpress.onchange = updateTotal;
paymentCOD.onchange = updatePaymentQR;
paymentQR.onchange = updatePaymentQR;

/* ===== TOAST ===== */
function toast(msg){
  const t = document.createElement("div");
  t.className = "toast-msg";
  t.textContent = msg;
  document.body.appendChild(t);
  setTimeout(()=>t.remove(),2000);
}

/* ===== CART ===== */
function loadCart(){
  const cart = JSON.parse(localStorage.getItem("cart")) || [];
  let total = 0;
  cartBox.innerHTML = "";
  if(cart.length === 0){
    cartBox.innerHTML = "<p class='text-muted text-center'>Cart is empty</p>";
    return;
  }
  cart.forEach(i=>{
    total += i.price * i.quantity;
    cartBox.innerHTML += `
      <div class="cart-item">
        <div>${i.name} √ó ${i.quantity}</div>
        <div>${i.price*i.quantity}</div>
      </div>`;
  });
  subTotal.textContent = total;
  sumSubtotal.textContent = total;
  updateTotal();
}

function updateTotal(){
  const d = delExpress.checked ? 30 : 0;
  deliveryFee.textContent = d;
  grandTotal.textContent = Number(sumSubtotal.textContent) + d;
}

/* ===== ADDRESS ===== */
async function loadAddresses(){
  addressSelect.innerHTML="<option disabled selected>Loading...</option>";
  try{
    const res = await fetch(`http://127.0.0.1:5000/addresses?user_id=${user.id}`);
    if(!res.ok) throw 0;
    const data = await res.json();
    addressSelect.innerHTML="";
    if(data.length === 0){
      addressSelect.innerHTML="<option disabled selected>No address</option>";
      return;
    }
    data.forEach(a=>{
      const o = document.createElement("option");
      o.value = a.id;
      o.textContent = `${a.address_line}, ${a.city}`;
      addressSelect.appendChild(o);
    });
  }catch{
    addressSelect.innerHTML="<option disabled selected>Cannot load address</option>";
  }
}

const saveAddressBtn = document.getElementById("saveAddressBtn");
saveAddressBtn.onclick = async function(){
  const addrLine = document.getElementById("addrLine");
  const addrCity = document.getElementById("addrCity");
  const addrPostal = document.getElementById("addrPostal");
  const addrPhone = document.getElementById("addrPhone");

  if(!addrLine.value||!addrCity.value||!addrPostal.value||!addrPhone.value){
    toast("Fill all fields"); return;
  }

  const payload = {
    user_id: parseInt(user.id),
    address_line: addrLine.value,
    city: addrCity.value,
    postal_code: addrPostal.value,
    phone: addrPhone.value,
    is_default: 0
  };

  try{
    const res = await fetch("http://127.0.0.1:5000/addresses",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify(payload)
    });
    if(!res.ok) throw 0;
    bootstrap.Modal.getInstance(document.getElementById("addressModal")).hide();
    addrLine.value = addrCity.value = addrPostal.value = addrPhone.value = "";
    loadAddresses();
    toast("Address added");
  }catch(err){
    console.error(err);
    toast("Save failed. Check console.");
  }
}

/* ===== PAYMENT QR ===== */
function updatePaymentQR(){
  if(paymentQR.checked){
    qrContainer.style.display = "block";
    const qrData = `foodiego://pay?user=${user.id}&amount=${grandTotal.textContent}`;
    if(qr) document.getElementById("qrcode").innerHTML = "";
    qr = new QRCode(document.getElementById("qrcode"), {
      text: qrData,
      width: 150,
      height: 150
    });
  }else{
    qrContainer.style.display = "none";
    if(qr) document.getElementById("qrcode").innerHTML = "";
  }
}

/* ===== CHECKOUT ===== */
function checkout(){
  const cart = JSON.parse(localStorage.getItem("cart")) || [];
  if(cart.length === 0){ toast("Cart is empty"); return; }
  if(!addressSelect.value){ toast("Select address"); return; }

  fetch("http://127.0.0.1:5000/orders",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({
      user_id: user.id,
      address_id: addressSelect.value,
      items: cart
    })
  })
  .then(res=>{ if(!res.ok) throw 0; return res.json(); })
  .then(()=>{ 
    toast("Order placed"); 
    localStorage.removeItem("cart"); 
    setTimeout(()=>location.href="dashboard.html",1200); 
  })
  .catch(()=>toast("Order failed"));
}

/* ===== INIT ===== */
loadCart();
loadAddresses();
</script>
</body>
</html>
